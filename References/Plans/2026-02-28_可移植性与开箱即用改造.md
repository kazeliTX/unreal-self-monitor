# 计划：UnrealMCP 可移植性与开箱即用改造

**日期**：2026-02-28
**目标**：将工具集从与单一工程强绑定，改造为可一键迁移至任意 UE 项目、自动识别环境、并在编辑器内提供原生开关界面的通用工具集。
**Git 分支**：ue/2026-02-28-portability-and-ux

---

## 一、现状痛点分析

| 痛点 | 根因 |
|------|------|
| 插件路径硬编在 MCPGameProject 下 | 插件作为示例工程的一部分，未独立发行 |
| mcp.json 路径需手动修改 | 没有自动发现机制 |
| 引擎版本写死在 .uplugin 中（`WhitelistPlatforms` / IWYUSupport） | 无版本兼容层 |
| MCP Socket 只能随编辑器启动自动开启，无法手动切换 | Bridge.Initialize() 直接调用 StartServer() |
| 迁移到新项目需要大量手动步骤 | 没有安装脚本 |

---

## 二、三阶段实现方案

### Phase A — 一键迁移安装脚本

**目标**：`python install.py <target_uproject_path>` 完成全部迁移

#### A1. 新增文件：`Python/scripts/install.py`

```
install.py <target_project.uproject> [--mcp-client claude|cursor|windsurf] [--no-claude-commands]
```

**执行步骤**：

```
① 解析 .uproject
   - 读取 EngineAssociation（引擎版本）
   - 读取已有 Plugins 列表（检查冲突）

② 复制插件
   - 源：<此仓库>/MCPGameProject/Plugins/UnrealMCP/
   - 目标：<target_project>/Plugins/UnrealMCP/
   - 若目标已存在 → 询问是否覆盖

③ 修补 .uproject
   - 向 Plugins 数组注入：
     {"Name": "UnrealMCP", "Enabled": true}
   - 若已存在则跳过

④ 生成 mcp.json
   - 路径：<target_project>/mcp.json
   - 自动填入 Python/ 目录绝对路径
   - 根据 --mcp-client 参数决定写入位置：
     · claude:   %USERPROFILE%\.config\claude-desktop\mcp.json (Windows)
                 ~/Library/Application Support/Claude/claude_desktop_config.json (Mac)
     · cursor:   <target_project>/.cursor/mcp.json
     · windsurf: %USERPROFILE%\.config\windsurf\mcp.json

⑤ 复制 .claude/commands/（可选，--no-claude-commands 跳过）
   - 复制到 <target_project>/.claude/commands/

⑥ 生成 VS 项目文件（Windows）
   - 通过 Windows 注册表定位引擎安装路径
   - 调用 <engine>/Engine/Build/BatchFiles/GenerateProjectFiles.bat

⑦ 输出迁移报告
   - 列出所有操作及其状态
   - 提示下一步：用 VS 打开 .sln 重新构建
```

#### A2. 引擎路径发现（Windows）

```python
# 注册表查找路径：
# HKEY_LOCAL_MACHINE\SOFTWARE\EpicGames\Unreal Engine\<version>\InstalledDirectory
# 或
# HKEY_CURRENT_USER\SOFTWARE\Epic Games\Unreal Engine\Builds  (自定义安装路径)
```

---

### Phase B — 项目自动识别与兼容性处理

**目标**：安装时自动检测引擎版本，按需打补丁；运行时 Python 工具自动读取工程信息。

#### B1. 新增 Python 工具：`Python/tools/project_info_tools.py`

注册为 `register_project_info_tools(mcp)`，提供：

| 工具 | 描述 |
|------|------|
| `get_project_info` | 读取 .uproject：引擎版本、模块列表、已启用插件 |
| `get_engine_install_info` | 引擎安装路径、版本号、平台 |
| `get_plugin_list` | 当前工程所有插件（系统级 + 工程级） |
| `check_mcp_compatibility` | 对照兼容矩阵，报告当前版本支持情况 |

#### B2. C++ 版本兼容层

在 `UnrealMCP.Build.cs` 中增加版本检测，自动适配：

```csharp
// 针对 UE5.4 及以下，禁用 IWYUSupport（改用旧 API）
if (Target.Version.MajorVersion == 5 && Target.Version.MinorVersion < 5)
{
    // 5.4 及以下：IWYUSupport 不存在，使用 bEnforceIWYU
    bEnforceIWYU = true;
}
else
{
    IWYUSupport = IWYUSupport.Full;
}
```

**兼容矩阵**（需逐版本验证）：

| UE 版本 | 已知差异 | 处理方式 |
|---------|---------|---------|
| 5.5 | IWYUSupport API、LiveCoding 模块名 | 当前基准，无需处理 |
| 5.4 | 使用 bEnforceIWYU | Build.cs 版本分支 |
| 5.3 | AssetTools API 细微差异 | `#if ENGINE_MINOR_VERSION < 4` |
| 5.2 | Enhanced Input 尚未稳定 | 运行时检查，降级提示 |
| 5.0/5.1 | UEditorSubsystem 部分 API 缺失 | 最低支持版本定为 5.2 |

#### B3. `.uplugin` 动态最低版本声明

将硬编码的 `WhitelistPlatforms` 改为支持全平台，引擎版本约束通过 `EngineVersion` 字段声明：

```json
{
  "EngineVersion": "5.2.0",
  "WhitelistPlatforms": ["Win64", "Mac", "Linux"]
}
```

---

### Phase C — 编辑器工具菜单（MCP Socket 开关）

**目标**：在 UE Editor 的 Tools 菜单下新增 "UnrealMCP" 子菜单，提供动态开关和状态显示。

#### C1. 取消自动启动

将 `Initialize()` 中的 `StartServer()` 改为读取用户偏好决定是否自启：

```cpp
// 读取 EditorSettings 中保存的偏好
bool bAutoStart = GetDefault<UUnrealMCPSettings>()->bAutoStartServer;
if (bAutoStart)
{
    StartServer();
}
```

#### C2. 新增配置类：`UnrealMCPSettings.h/.cpp`

```cpp
UCLASS(config=EditorSettings, defaultconfig)
class UUnrealMCPSettings : public UDeveloperSettings
{
    GENERATED_BODY()
public:
    // 是否随编辑器自动启动 MCP Server
    UPROPERTY(config, EditAnywhere, Category="MCP Server")
    bool bAutoStartServer = true;

    // 监听端口（默认 55557）
    UPROPERTY(config, EditAnywhere, Category="MCP Server")
    int32 Port = 55557;
};
```

配置自动出现在 **Edit → Project Settings → Plugins → UnrealMCP**。

#### C3. 注册工具菜单

在 `Initialize()` 中注册，在 `Deinitialize()` 中清理：

```cpp
void UUnrealMCPBridge::Initialize(FSubsystemCollectionBase& Collection)
{
    // ... existing init code ...

    // 注册菜单（延迟到 ToolMenus 系统就绪后）
    UToolMenus::RegisterStartupCallback(
        FSimpleMulticastDelegate::FDelegate::CreateUObject(
            this, &UUnrealMCPBridge::RegisterMenus));

    // 按配置决定是否自启
    if (GetDefault<UUnrealMCPSettings>()->bAutoStartServer)
        StartServer();
}

void UUnrealMCPBridge::RegisterMenus()
{
    UToolMenu* Menu = UToolMenus::Get()->ExtendMenu("MainFrame.MainMenu.Tools");
    FToolMenuSection& Section = Menu->AddSection(
        "UnrealMCPSection",
        LOCTEXT("UnrealMCPHeading", "UnrealMCP"));

    // 切换开关（带勾选状态）
    Section.AddMenuEntry(
        "ToggleMCPServer",
        LOCTEXT("ToggleMCPServer", "MCP Server"),
        LOCTEXT("ToggleMCPServerTip", "Start or stop the MCP TCP server (port 55557)"),
        FSlateIcon(FAppStyle::GetAppStyleSetName(), "Icons.Toolbar.Settings"),
        FUIAction(
            FExecuteAction::CreateUObject(this, &UUnrealMCPBridge::ToggleServer),
            FCanExecuteAction(),
            FIsActionChecked::CreateUObject(this, &UUnrealMCPBridge::IsRunning)
        ),
        EUserInterfaceActionType::ToggleButton
    );
}

void UUnrealMCPBridge::ToggleServer()
{
    if (bIsRunning) StopServer();
    else            StartServer();
}
```

**菜单效果**：

```
Tools
└─ UnrealMCP
   └─ ✓ MCP Server   ← 勾选 = 运行中，点击切换
```

#### C4. 扩展状态栏（可选，Phase C 后期）

在编辑器底部状态栏显示 MCP 连接状态（绿点/红点），类似 Live Coding 状态指示器。

---

## 三、受影响文件清单

### 新增文件

| 文件 | 说明 |
|------|------|
| `Python/scripts/install.py` | 一键迁移脚本 |
| `Python/tools/project_info_tools.py` | 工程信息查询 MCP 工具 |
| `MCPGameProject/Plugins/UnrealMCP/Source/UnrealMCP/Public/UnrealMCPSettings.h` | 编辑器配置类 |
| `MCPGameProject/Plugins/UnrealMCP/Source/UnrealMCP/Private/UnrealMCPSettings.cpp` | 配置实现 |

### 修改文件

| 文件 | 变更内容 |
|------|---------|
| `UnrealMCPBridge.h` | 新增 `RegisterMenus()`, `ToggleServer()` 声明 |
| `UnrealMCPBridge.cpp` | Initialize() 改为读配置决定自启；注册 ToolMenus |
| `UnrealMCP.Build.cs` | 版本兼容分支；确保 `ToolMenus`、`DeveloperSettings` 已引用 |
| `UnrealMCP.uplugin` | 更新最低引擎版本声明 |

---

## 四、风险点

| 风险 | 概率 | 缓解措施 |
|------|------|---------|
| UE5.2/5.3 API 差异导致编译失败 | 中 | 逐版本验证，使用 `#if` 隔离；最低支持版本定 5.2 |
| ToolMenus 在 headless 或 commandlet 模式下不可用 | 低 | `GIsEditor` 守卫，仅在编辑器模式注册 |
| Windows 注册表查找引擎路径失败（自定义安装） | 中 | 降级到环境变量 `UE_ROOT`，或让用户手动输入 |
| .uproject 注入后工程无法识别插件（大小写/路径问题） | 低 | 注入前备份 .uproject；注入后做 JSON 验证 |
| install.py 在 Mac/Linux 上路径处理不一致 | 中 | 全程使用 `pathlib.Path`，避免字符串拼接 |

---

## 五、执行步骤（分优先级）

### P0 — 核心价值，优先实现
- [ ] Phase C：编辑器菜单开关（改动小，用户价值高）
  - [ ] C2: 新增 `UUnrealMCPSettings`
  - [ ] C3: `RegisterMenus()` + `ToggleServer()`
  - [ ] C1: Initialize() 改为读配置自启

### P1 — 迁移能力
- [ ] Phase A：`install.py` 安装脚本
  - [ ] A1: 基础流程（复制插件 + 修补 .uproject + 生成 mcp.json）
  - [ ] A2: 引擎路径发现（Windows 注册表 + 回退机制）
  - [ ] 跨平台验证（Mac/Linux）

### P2 — 兼容性与信息查询
- [ ] Phase B: `project_info_tools.py`
- [ ] Phase B: Build.cs 版本兼容分支
- [ ] Phase B: 兼容矩阵验证（5.2 ~ 5.5）

---

## 六、验收标准

- [ ] 在一个全新的空 UE5.5 工程上执行 `python install.py` 后，无需手动操作即可连接 MCP
- [ ] UE Editor Tools 菜单出现 "MCP Server" 开关，点击可切换状态
- [ ] 插件在 UE5.3 上编译通过（或明确输出版本不兼容提示）
- [ ] `get_project_info` 工具返回正确的引擎版本和工程目录信息
- [ ] 冒烟测试在迁移后的新工程中全部通过
