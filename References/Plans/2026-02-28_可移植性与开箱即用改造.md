# 计划：UnrealMCP 可移植性与开箱即用改造

**日期**：2026-02-28（更新：加入 UE4 兼容性）
**目标**：将工具集从与单一工程强绑定，改造为可一键迁移至任意 UE4/UE5 项目、自动识别环境、并在编辑器内提供原生开关界面的通用工具集。
**参考工程**：`E:\kazeli_KAZELI-PC0_S1_2\NZMobile`（UE 4.24.2 源码编译）

---

## 一、现状痛点分析

| 痛点 | 根因 |
|------|------|
| 插件路径硬编在 MCPGameProject 下 | 插件作为示例工程的一部分，未独立发行 |
| mcp.json 路径需手动修改 | 没有自动发现机制 |
| 仅支持 UE5（IWYUSupport、FAppStyle、BlueprintEditorLibrary 等均为 UE5 API） | 无版本兼容层 |
| MCP Socket 只能随编辑器启动自动开启，无法手动切换 | ✅ 已修复（Phase C） |
| 迁移到新项目需要大量手动步骤 | 没有安装脚本 |

---

## 二、UE4 vs UE5 兼容差异（基于 NZMobile UE4.24 分析）

### 2.1 C++ API 差异矩阵

| 功能 | UE4（4.22+） | UE5 | 处理方式 |
|------|-------------|-----|---------|
| IWYU 配置 | `bEnforceIWYU = true` | `IWYUSupport = IWYUSupport.Full` | Build.cs 版本分支 |
| 编辑器样式 | `FEditorStyle::GetStyleSetName()` | `FAppStyle::GetAppStyleSetName()` | `#if ENGINE_MAJOR_VERSION >= 5` |
| 平台白名单字段 | `WhitelistPlatforms` | `PlatformAllowList` | .uplugin 保留旧字段（4/5均兼容） |
| 平台黑名单字段 | `BlacklistPlatforms` | `PlatformDenyList` | 同上 |
| BlueprintEditorLibrary | ❌ 不存在 | ✅ 存在 | Build.cs 条件引入，功能降级 |
| EditorScriptingUtilities | ⚠️ 部分 API 不同 | ✅ 完整 | 逐命令检查，缺失时返回错误 |
| LiveCoding 模块 | `LiveCoding`（4.22+） | `LiveCoding` | 运行时 `IsModuleLoaded` 检测 |
| Enhanced Input | ❌ 不存在 | ✅ 存在 | ProjectCommands 降级：禁用相关命令 |
| UEditorSubsystem | ✅（4.22+） | ✅ | 无需处理 |
| UToolMenus | ✅（4.22+） | ✅ | 无需处理 |
| UDeveloperSettings | ✅ | ✅ | 无需处理 |

### 2.2 NZMobile 项目特殊情况

| 特征 | 详情 | 对安装的影响 |
|------|------|------------|
| 引擎类型 | 源码编译（EngineAssociation = ""） | 引擎在 `../Engine/` 相对路径，无需查注册表 |
| 引擎版本 | UE 4.24.2 | `ENGINE_MAJOR_VERSION=4, ENGINE_MINOR_VERSION=24` |
| 模块规模 | 25+ 模块，`ClientOnly`/`ServerOnly`/`UncookedOnly` 混合 | 安装脚本需检测 UnrealMCP 是否为 `Editor` 类型 |
| 插件数量 | 100+ 插件 | 检查名称冲突即可，无需全量扫描 |
| Enhanced Input | 无（UE4 内置 Input System） | ProjectCommands 中 Enhanced Input 相关命令需在 UE4 下禁用 |

---

## 三、三阶段实现方案（更新版）

### Phase A — 一键迁移安装脚本（含 UE4 支持）

**目标**：`python install.py <target_uproject_path>` 支持 UE4.22+/UE5.x

#### A1. 新增文件：`Python/scripts/install.py`

```
install.py <target_project.uproject> [--mcp-client claude|cursor|windsurf] [--no-claude-commands] [--dry-run]
```

**执行流程**：

```
① 读取 .uproject
   - 引擎版本（EngineAssociation：空=源码，版本号=Launcher）
   - 已有 Plugins 列表（冲突检测）
   - 模块类型（确保 UnrealMCP 以 Editor 类型加入）

② 定位引擎路径
   - 源码编译（EngineAssociation=""）→ 相对 .uproject 向上查找 Engine/
   - Launcher 安装 → Windows 注册表 HKLM\SOFTWARE\EpicGames\Unreal Engine\<ver>
   - 环境变量回退：UE_ROOT
   - 均失败 → 提示用户手动输入

③ 读取引擎版本（Engine/Build/Build.version）
   - 确定 MajorVersion / MinorVersion
   - 对照兼容矩阵，输出警告（如：Enhanced Input 在 UE4 下不可用）

④ 复制插件
   - 源：<此仓库>/MCPGameProject/Plugins/UnrealMCP/
   - 目标：<target_project>/Plugins/UnrealMCP/
   - 若目标已存在：询问是否覆盖（--dry-run 跳过）

⑤ 修补 .uproject
   - 注入：{"Name": "UnrealMCP", "Enabled": true}
   - 若已存在则跳过

⑥ 生成 mcp.json（按 --mcp-client 写入对应位置）
   - 自动填写 Python/ 绝对路径

⑦ 可选：复制 .claude/commands/

⑧ 可选：调用 GenerateProjectFiles（源码编译工程）
   - 源码编译：<engine_root>/GenerateProjectFiles.bat <uproject_path>
   - Launcher：UnrealBuildTool GenerateProject

⑨ 输出安装报告（兼容性警告 + 下一步操作提示）
```

#### A2. 引擎路径发现逻辑

```python
def find_engine_root(uproject_path: Path) -> tuple[Path, str]:
    """返回 (engine_root, source) source = 'sibling'|'registry'|'env'|'manual'"""
    # 1. 源码编译检测（Engine/ 在同级目录）
    sibling_engine = uproject_path.parent.parent / "Engine"
    if (sibling_engine / "Build" / "Build.version").exists():
        return sibling_engine.parent, "sibling"

    # 2. Windows 注册表
    # HKLM\SOFTWARE\EpicGames\Unreal Engine\<version>\InstalledDirectory
    # HKCU\SOFTWARE\Epic Games\Unreal Engine\Builds (自定义路径映射)

    # 3. 环境变量
    if ue_root := os.environ.get("UE_ROOT"):
        return Path(ue_root), "env"

    # 4. 手动输入
    return None, "manual"
```

---

### Phase B — 自动检测与兼容性处理

#### B1. C++ 版本兼容层（Build.cs）

```csharp
bool bIsUE5 = (Target.Version.MajorVersion >= 5);

// IWYU
if (bIsUE5)
    IWYUSupport = IWYUSupport.Full;
else
    bEnforceIWYU = true;

// BlueprintEditorLibrary 仅 UE5 可用
if (bIsUE5 && Target.bBuildEditor)
    PrivateDependencyModuleNames.Add("BlueprintEditorLibrary");
```

#### B2. C++ API 兼容宏（在公共头文件中定义）

新建 `UnrealMCPCompat.h`：

```cpp
#pragma once

// FAppStyle / FEditorStyle 兼容
#if ENGINE_MAJOR_VERSION >= 5
    #define MCP_STYLE_NAME FAppStyle::GetAppStyleSetName()
#else
    #define MCP_STYLE_NAME FEditorStyle::GetStyleSetName()
#endif

// Enhanced Input 仅 UE5 支持
#if ENGINE_MAJOR_VERSION >= 5
    #define MCP_ENHANCED_INPUT_SUPPORTED 1
#else
    #define MCP_ENHANCED_INPUT_SUPPORTED 0
#endif
```

在 `UnrealMCPBridge.cpp` 的 `RegisterMenus()` 中将 `FAppStyle::GetAppStyleSetName()` 替换为 `MCP_STYLE_NAME`。

在 `UnrealMCPProjectCommands.cpp` 中将 Enhanced Input 相关命令用 `#if MCP_ENHANCED_INPUT_SUPPORTED` 包裹。

#### B3. Python 工具：`project_info_tools.py`

| 工具 | 描述 |
|------|------|
| `get_project_info` | 读取 .uproject：引擎版本、模块列表、已启用插件 |
| `get_engine_install_info` | 引擎路径、版本号、构建类型（源码/Launcher） |
| `check_mcp_compatibility` | 对照兼容矩阵，列出当前版本受限命令 |

#### B4. .uplugin 更新

- 将 `WhitelistPlatforms` 保留（UE4/5 均识别）
- 添加 `EngineVersion: "4.22.0"`（最低版本声明）
- 移除硬编码的 `5.5` 相关内容

---

### Phase C — 编辑器菜单 ✅ 已完成

- `UUnrealMCPSettings` + `RegisterMenus()` + `ToggleServer()` 已实现
- 待处理：将 `FAppStyle::GetAppStyleSetName()` 替换为 `MCP_STYLE_NAME` 以兼容 UE4

---

## 四、受影响文件清单（更新版）

### 新增文件

| 文件 | 说明 |
|------|------|
| `Python/scripts/install.py` | 一键迁移脚本（UE4/UE5 双支持） |
| `Python/tools/project_info_tools.py` | 工程信息查询 MCP 工具 |
| `MCPGameProject/Plugins/UnrealMCP/Source/UnrealMCP/Public/UnrealMCPCompat.h` | 版本兼容宏定义 |
| `References/SOP/Install_SOP.md` | 自动化安装 SOP |

### 修改文件

| 文件 | 变更内容 |
|------|---------|
| `UnrealMCP.Build.cs` | UE4/5 分支：IWYU / BlueprintEditorLibrary |
| `UnrealMCPBridge.cpp` | `FAppStyle` → `MCP_STYLE_NAME` |
| `UnrealMCPProjectCommands.cpp` | Enhanced Input 命令用 `#if` 隔离 |
| `UnrealMCP.uplugin` | 添加最低引擎版本，去除 UE5 特有字段 |

---

## 五、执行步骤（更新优先级）

### P0 — 已完成
- [x] Phase C：编辑器菜单开关 + UUnrealMCPSettings

### P1 — 下一步（UE4 兼容核心）
- [x] 新建 `UnrealMCPCompat.h`（`MCP_STYLE_NAME` + `MCP_ENHANCED_INPUT_SUPPORTED`）
- [x] Build.cs：移除 `IWYUSupport`（UE5-only），`BlueprintEditorLibrary` 条件引入（`MajorVersion >= 5`）
- [x] `UnrealMCPBridge.cpp`：`FAppStyle` → `MCP_STYLE_NAME`
- [x] `UnrealMCPProjectCommands.cpp`：Enhanced Input 注册与实现用 `#if MCP_ENHANCED_INPUT_SUPPORTED` 隔离，UE4 下提供 stub
- [x] `.uplugin`：添加 `"EngineVersion": "4.22.0"`

### P2 — 安装脚本
- [ ] `install.py`：核心流程（检测引擎 + 复制插件 + 修补 .uproject）
- [ ] `install.py`：源码编译路径发现（NZMobile 场景）
- [ ] `install.py`：Launcher 注册表路径发现（UE5 场景）
- [ ] `install.py`：兼容性报告输出

### P3 — Python 工具
- [ ] `project_info_tools.py`：`get_project_info` / `check_mcp_compatibility`

---

## 六、验收标准（更新版）

- [ ] 在 NZMobile（UE4.24.2 源码编译）上执行 `python install.py` 后，插件正确注入 .uproject
- [ ] 插件在 UE4.24 下编译通过（Enhanced Input 相关代码被条件编译排除）
- [ ] UE Editor Tools 菜单在 UE4 和 UE5 下均能显示 MCP Server 开关
- [ ] `get_project_info` 正确识别 NZMobile 为 UE4.24.2 源码编译
- [ ] 冒烟测试在 UE4.24 下的可用命令子集上全部通过
