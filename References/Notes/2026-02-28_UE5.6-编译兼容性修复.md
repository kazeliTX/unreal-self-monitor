# 问题：UE5.6 + VS2022 14.44 编译失败（三处兼容性问题）

**日期**：2026-02-28
**影响模块**：UnrealMCPEditorCommands.cpp、UnrealMCPTestCommands.cpp、MCPServerRunnable.cpp
**严重程度**：高（插件无法编译）
**触发场景**：首次将插件安装到 UE5.6 + LyraStarterGame，使用 VS2022 14.44.35207

---

## 现象

UBT 编译 `LyraEditor` 时出现三类错误，导致 `Result: Failed (OtherCompilationError)`。

---

## 错误1：`Engine/SkyAtmosphere.h` 不存在

```
UnrealMCPEditorCommands.cpp(22,1): fatal error C1083:
  无法打开包括文件: "Engine/SkyAtmosphere.h": No such file or directory
```

**根因**：`ASkyAtmosphere` Actor 类定义在 `Components/SkyAtmosphereComponent.h`，不在 `Engine/SkyAtmosphere.h`。后者在任何 UE 版本中均不存在。

**修复**：
```cpp
// ❌ 错误
#include "Engine/SkyAtmosphere.h"

// ✅ 正确
#include "Components/SkyAtmosphereComponent.h"
```

---

## 错误2：`Engine/WorldSettings.h` 不存在（UE5.6）

```
UnrealMCPEditorCommands.cpp(31,1): fatal error C1083:
  无法打开包括文件: "Engine/WorldSettings.h": No such file or directory
```

**根因**：代码中用 `#if ENGINE_MAJOR_VERSION >= 5` 条件包含 `Engine/WorldSettings.h`，但该路径在 UE5.6 中不存在。UE4 和 UE5 中 `WorldSettings.h` 均位于 `GameFramework/WorldSettings.h`。

**修复**：删除版本条件判断，统一使用：
```cpp
// ✅ UE4/UE5 通用
#include "GameFramework/WorldSettings.h"
```

---

## 错误3：VS2022 14.44 C4459 — `StringConv.h` 变量名遮蔽全局声明

```
Engine/Source/Runtime/Core/Public/Containers/StringConv.h(688,9): error C4459:
  "BufferSize"的声明隐藏了全局声明
Error executing cl.exe (tool returned code: 2)
```

**根因**：VS2022 14.44.35207 将 C4459（局部变量名遮蔽全局名称）警告升级为错误。`StringConv.h` 内部的 `TStringConversion` 模板有一个名为 `BufferSize` 的模板参数，遮蔽了某个全局声明。`MCPServerRunnable.cpp` 使用了 `FTCHARToUTF8` 宏（展开后使用此模板），从而触发了该错误。这是 UE 引擎头文件与 VS2022 14.44 之间的已知兼容性问题。

**修复**：在 `MCPServerRunnable.cpp` 文件头部禁用该警告（仅作用于本文件）：
```cpp
// VS2022 14.44+ treats C4459 (variable shadowing global) as error in StringConv.h template.
#ifdef _MSC_VER
#pragma warning(disable: 4459)
#endif
```

同时将 `TCHAR_TO_UTF8` 宏替换为等效的 `FTCHARToUTF8` 直接调用，并修正字节长度（原代码用 `Response.Len()` 是 TCHAR 字符数，不是 UTF-8 字节数）：
```cpp
// ❌ 原代码（字节长度有误）
ClientSocket->Send((uint8*)TCHAR_TO_UTF8(*Response), Response.Len(), BytesSent);

// ✅ 修复后（正确字节长度）
FTCHARToUTF8 Utf8Response(*Response);
ClientSocket->Send((const uint8*)Utf8Response.Get(), Utf8Response.Length(), BytesSent);
```

---

## 额外错误（源码引擎）：所有 JSON 文件均触发 C4459

```
Module.UnrealMCP.cpp → StringConv.h(688,9): error C4459: "BufferSize" hides global declaration
```

**根因**：源码引擎（UnrealEngine_5_6）与 Launcher 引擎（UE_5.6）的 UBT 行为不同。源码引擎以 Unity Build 编译 UnrealMCP 插件，所有 .cpp 文件合并为一个 `Module.UnrealMCP.cpp`。由于 C4459 只在 `MCPServerRunnable.cpp` 中用 `#pragma warning(disable: 4459)` 抑制，合并文件中排在它之前的 .cpp（如 `UnrealMCPUMGCommands.cpp`）未受保护，仍会触发 C4459 错误。

**修复**：在 `Build.cs` 中对整个模块禁用 C4459：
```csharp
// UE5.3-5.5 API：
ShadowVariableWarningLevel = WarningLevel.Off;
// UE5.6 新 API（CS0618 弃用旧 API，但旧 API 仍工作）：
// CppCompileWarningSettings.ShadowVariableWarningLevel = WarningLevel.Off;
```

**注意**：
- UE4 中此属性名为 `bEnableShadowVariableWarnings = false`（bool）
- UE5.3-5.5：`ShadowVariableWarningLevel = WarningLevel.Off`
- UE5.6+：`CppCompileWarningSettings.ShadowVariableWarningLevel = WarningLevel.Off`（旧 API 仍可用，仅有 CS0618 弃用警告）
- `MCPServerRunnable.cpp` 中的 `#pragma warning(disable: 4459)` 仍保留（兼容性）

---

## 额外错误：`TActorIterator<AActor>` 未定义

```
UnrealMCPTestCommands.cpp(141,33): error C2079:
  "It"使用未定义的 class"TActorIterator<AActor>"
```

**根因**：`UnrealMCPTestCommands.cpp` 缺少 `#include "EngineUtils.h"`（`TActorIterator` 定义所在头文件）。这是已知的 UE4 兼容性笔记中提到的问题（见 `2026-02-28_UE4-compat-fixes.md`），但在 UE5.6 上同样复现。

**修复**：在文件 include 区域添加：
```cpp
#include "EngineUtils.h"
```

---

## 涉及文件

- `Private/Commands/UnrealMCPEditorCommands.cpp`
- `Private/Commands/UnrealMCPTestCommands.cpp`
- `Private/MCPServerRunnable.cpp`
- `UnrealMCP.Build.cs`（新增 `ShadowVariableWarningLevel = WarningLevel.Off` 修复源码引擎 Unity Build 问题）

---

## 预防措施 / 经验提炼

1. **`ASkyAtmosphere` 的头文件** 永远是 `Components/SkyAtmosphereComponent.h`，没有 `Engine/SkyAtmosphere.h`
2. **`WorldSettings.h`** 在 UE4 和 UE5 中统一使用 `GameFramework/WorldSettings.h`，不需要版本条件
3. **VS2022 14.44+ C4459（完整修复）**：
   - Launcher 引擎（Adaptive Build）：仅 `MCPServerRunnable.cpp` 触发，`#pragma warning(disable: 4459)` 即可
   - 源码引擎（Unity Build）：整个模块编译为一个文件，`#pragma` 不够，必须在 `Build.cs` 中设置 `ShadowVariableWarningLevel = WarningLevel.Off`
4. **`TActorIterator`** 需要 `#include "EngineUtils.h"`，新建使用它的文件时必须检查
5. **`Build.cs` 中的 ShadowVariableWarningLevel API 版本差异**（见上方额外错误节）
