# 问题：Stop Hook 脚本格式错误

**日期**：2026-02-28
**影响模块**：`.claude/settings.local.json`、`Python/scripts/session_end_reminder.py`
**严重程度**：高（Hook 完全无法工作）

## 现象
Stop hook 触发后报错，无法正常执行。

## 根因

### 错误1：stdout 被污染
Claude Code 通过 **stdout** 读取 hook 的 JSON 响应。原脚本直接用 `print()` 输出提示文字，导致 Claude 收到非 JSON 内容 → 解析崩溃。

### 错误2：无限循环风险
Stop hook 触发后，若返回 `"decision": "block"`，Claude 会再次生成响应，响应完成后 Stop hook 再次触发。
原脚本没有检查 `stop_hook_active` 标志，会陷入无限循环。

### 错误3：Windows 路径未加引号
`settings.local.json` 中的 command 字段路径含空格但未加引号：
```json
// 错误
"command": "python C:/Users/kazeli/Desktop/unreal-mcp-main/..."

// 正确
"command": "python \"C:/Users/kazeli/Desktop/unreal-mcp-main/...\""
```

## 解决方案

1. **脚本 stdout 只输出 JSON**，调试信息用 `sys.stderr`
2. **首行检查 `stop_hook_active`**，为 true 时直接 `sys.exit(0)`
3. **command 路径加引号**（含空格的 Windows 路径必须）

### 修复后脚本结构
```python
hook_input = json.load(sys.stdin)           # 读 JSON 输入
if hook_input.get("stop_hook_active"):      # 防止无限循环
    sys.exit(0)
print(json.dumps({"decision": "block", "reason": "..."}))  # JSON 输出
sys.exit(0)
```

## 预防措施 / 经验提炼

> **Claude Code Hook 三条铁律**：
> 1. **stdout 只能是 JSON**——绝对不能有任何 print() 文字
> 2. **Stop hook 必须检查 `stop_hook_active`**——否则无限循环
> 3. **Windows 路径含空格必须加引号**

验证命令：
```bash
# 正常触发（应输出 JSON）
echo '{"stop_hook_active": false}' | python "path/to/script.py"

# 防循环守卫（应静默退出 0）
echo '{"stop_hook_active": true}' | python "path/to/script.py"
```
